# Заметки по Debezium

**Цель 1:** Научиться использовать Debezium для чтения заменений в базе данных PostgreSQL и передачи этих изменений в Kafka.
**Цель 2:** В системе где kafka используется как шина данных, научиться правильно настраивать Debezium для обеспечения надежной доставки сообщений вместо отдельных сервисов консумеров и продюсеров.
**Цель 3:** Попробовать и реализовать паттерн transactional outbox с использованием Debezium и Kafka Streams.

Debezium — это платформа с открытым исходным кодом для отслеживания изменений в базах данных в режиме реального времени. Она позволяет захватывать изменения данных (CDC) и передавать их в различные системы, такие как Apache Kafka, для дальнейшей обработки и анализа. В этом руководстве мы рассмотрим основные шаги по установке и использованию Debezium.

Официальный сайт Debezium: [https://debezium.io/](https://debezium.io/)

## Полезные ресурсы

- transactional outbox pattern - https://www.youtube.com/watch?v=JssjO__iqy0
- Kafka Streams (На примере OUTBOX pattern, Kafka Connect, Debezium) - https://www.youtube.com/watch?v=uaT_AJujPnw
- Евгений Ефименко: Debezium - Баттута в руках инженера https://www.youtube.com/watch?v=IPV6WVx71k8
- https://zh-efimenko.github.io/demo-debezium/

## Репликационный слот

Если база данных PostgreSQL используется с Debezium, необходимо создать репликационный слот для захвата изменений. Репликационные слоты позволяют сохранять состояние репликации и обеспечивают надежную доставку изменений.

Что такое слот репликации в PostgreSQL?
Это когда мы просим PostgreSQL сохранять все изменения в базе данных (WAL файлы) до тех пор, пока мы их не прочитаем. Это полезно для систем, которые хотят отслеживать изменения в базе данных, например, Debezium.

При подключении Debezium к базе данных PostgreSQL, нужно напречься, т.к. можно легко сломать базу данных.

Смена мастера PostgreSQL 17 идет лучше, слот репликации переезжает на новый мастер автоматически.

Но если debezium сервер умрет, то слот останется и будет накапливать WAL файлы, что может привести к переполнению диска. Поэтому рекомендуется периодически проверять и очищать неиспользуемые слоты.

- pg_watch мониторинг реплика слотов
- debeizium может автоматически удалять слоты при остановке коннектора, если настроен параметр `slot.drop.on.stop=true`
- команда для удаления слота: `SELECT pg_drop_replication_slot('slot_name');`
- плохой монитиринг у debezium

### Heartbeat хаки для WAL

Почитать про lowtrafik и hightrafik, например когда debezium слушает таблицу в которой мало изменений, lowtrafik когда оффсет не смещается и WAL файлы накапливаются. (Решают хитрым трюком через heartbeat таблицу).

Просто создают таблицу public.heartbeat с колонкой ts типа timestamptz и периодически туда пишут текущую дату, чтобы debezium видел активность и не думал что база простаивает.

Бывают случаи когда сеть моргнула и debezium не может подключиться к базе данных, в этом случаи помогает перезапуск коннектора.

### Проблемы и ограничения Debezium

- Легко вшатать базу данных, если не правильно настроить debezium
- Когда debezium развернут в k8s как монолитное приложение, а kafka используется как шина данных, то в случаи проблем с debezium все остальные сервисы зависящие от него тоже встанут.
- Debezium не умеет в scale-out, т.е. нельзя запустить несколько инстансов debezium на одну базу данных, иначе они будут мешать друг другу.
- Нужно использовать минимальный конфиг debezium, чтобы уменьшить вероятность ошибок
- Изменения становятся сложнее, когда debezium подключается к базе данных, то получается какое то подобие контракта которому нужно следовать. Если кто то изменит таблицу, то нужно будет менять и конфиг debezium или consumer-ов
- Не стоит под каждый сервис подстраиваться и писать модификации, пусть разгребают consumers будет проще управлять всем этим
- Не умеет join таблицы, просто подписываемся на журналы, и если какой то сервиса делает запись в сразу несколько таблица, то debeziunm не сможет это связать и просто в хоатиччном порядке отправит эти записи в кафку. Можно гонку поймать когда например придет сначало второстипенное событие, до того как придет основное. И системам нужно решать эту систему.
- Хорошо рабатает в PostgreSQL, с другими базами данных возможно потребуются костыли, PostgreSQL это родная база данных для debezium и лучше использовать версию PostgreSQL выше 17, где есть улучшенная логика репликации.

## Kafka UI для мониторинга Kafka топиков

**Github:** https://github.com/kafbat/kafka-ui

Kafka UI - это удобный веб-интерфейс для мониторинга и управления кластерами Apache Kafka. Он позволяет просматривать топики, потребителей, продюсеров и другие метрики в реальном времени.
